<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html"> 

<link rel="import" href="shared-styles.html">
<dom-module id="property-details">
    <template>
        <style include="shared-styles">
            :host {
                display: block
            }
            .prop-details{
              width:90%;
              float:left;              
              min-height: 300px;              
              padding:10px 20px;
              box-sizing: border-box;              
              //margin:auto 5%;
              //margin-top: 80px;
              //border: 2px solid #F60;
            } 

	        .prop-details paper-input,.prop-details paper-dropdown-menu{
	             //width:100%;
	             //float:left;
	             margin:0 1% 0 ; 
	        }
          .prop-details paper-input.smallBox{
            width: 10%;
          }
          .prop-details paper-input.mediumBox{
            width: 29%;
          }
          .prop-details paper-input.largeBox{
            width: 60%;
          }
          .prop-details .floatBox {
            float: left;
          }
          .prop-details paper-button {
            align: center;
            margin:0 1% 0 ;
          }
          paper-spinner-lite {
            --paper-spinner-color: #FF6600;
            position: absolute;
            top: 290px;
            left: 600px;
          }
        </style>
        <div class="prop-details">
         <!-- <h3>Property Details</h3> -->
        	<section>
            <paper-spinner-lite active$="{{isActive}}" class="orange active"></paper-spinner-lite>
          		<paper-input name="propDoorNo" class="smallBox" label="Door Number" id="propDoorNo" value="{{propertydetails.propDoorNo::input}}"></paper-input>
        			<paper-input name="propAddressLine1" class="largeBox" label="Address Line 1" id="propAddressLine1" value="{{propertydetails.propAddressLine1::input}}"></paper-input>
        			<paper-input name="propAddressLine2"  class="largeBox" label="Address Line 2" id="propAddressLine2" value="{{propertydetails.propAddressLine2::input}}"></paper-input>
              <paper-input name="propPostCode" class="mediumBox floatBox" label="Post Code" id="propPostCode" value="{{propertydetails.propPostCode::input}}" required auto-validate error-message="Post code required" on-blur="getCityInfo"></paper-input>
        			<paper-input name="propCity" class="mediumBox floatBox" disabled label="City" id="propCity" value="{{propertydetails.propCity::input}}"></paper-input>
              <div style="clear: both"></div>
              <br/>
              <paper-button raised class="custom orange" on-click="submitDetails">Submit</paper-button>
              
              <iron-ajax id="cityInfoReq" url={{postCodeApiUrl}} method="post"
                         body='{{postalCodeInfo}}' handle-as="json" on-response="handleCityInfoResponse">
              </iron-ajax>
              <iron-ajax id="propDetailsReq" url="http://10.138.13.156:8080/lightningmortgage/property/add" method="post" body='{{propDetailsData}}' handle-as="json" content-type="application/json" on-response="handlePropDetailsResponse">
              </iron-ajax>
        	  </section>
        </div>
    </template>
    <script>
        class PropertyDetails extends Polymer.Element {

            static get is() { return 'property-details'; }
            static get properties() {
                return {
                  propertydetails:{
                        type:Object,
                        value:{},
                        notify:true,
                        reflectToAttribute:true
                    },
                    isActive:{
                      type : Boolean,
                      value : false
                    },
                    propDetailsData:{
                        type:Object,
                        value:{"propertyDetails" :{}},
                        notify:true,
                        //reflectToAttribute:true
                    },
                }
            }
            constructor() {
                super();
            }
            getCityInfo(){
              this.isActive = true;

              let postCode = this.propertydetails.propPostCode;
              if(postCode!="undefined" && postCode!="")
              this.postCodeApiUrl = "https://api.bring.com/shippingguide/api/postalCode.json?clientUrl=t&country=NL&pnr="+postCode;
              this.$.cityInfoReq.generateRequest();
            }
            submitDetails() {
              //API URL -- http://10.138.13.156:8080/lightningmortgage/property/add
              console.log("hi"+JSON.stringify(this.propertydetails));
              //{"propDoorNo":"11","propAddressLine1":"Address1","propAddressLine2":"Address2","propPostCode":"8211"}
              this.propDetailsData.propertyDetails["doorNumber"]= "";
              if(this.propertydetails["propDoorNo"]!="undefined")
                this.propDetailsData.propertyDetails["doorNumber"]=this.propertydetails["propDoorNo"];
              
              this.propDetailsData.propertyDetails["addressLine1"] = "";
              if(this.propertydetails["addressLine1"]!="undefined")
                this.propDetailsData.propertyDetails["addressLine1"]=this.propertydetails["propAddressLine1"];

              this.propDetailsData.propertyDetails["addressLine2"] = "";
              if(this.propertydetails["addressLine2"]!="undefined")
                this.propDetailsData.propertyDetails["addressLine2"]=this.propertydetails["propAddressLine2"];

              this.propDetailsData.propertyDetails["postalCode"]="";
              if(this.propertydetails["postalCode"]!="undefined")
                this.propDetailsData.propertyDetails["postalCode"]=this.propertydetails["propPostCode"];

              this.propDetailsData.propertyDetails["city"]="";
              if(this.propertydetails["city"]!="undefined")
                this.propDetailsData.propertyDetails["city"]=this.propertydetails["propCity"];
              
              console.log("hi"+JSON.stringify(this.propDetailsData));
              this.$.propDetailsReq.generateRequest();
            }
            handleCityInfoResponse(res){
              //alert("jjjj");
              //console.log(JSON.stringify(res.detail.response));
              let valid = res.detail.response.valid;
              if(valid){
                //console.log(JSON.stringify(res.detail.response.result));
                this.$.propCity.value = res.detail.response.result;
                this.propertydetails["propCity"] = res.detail.response.result;
              } else {
                this.$.propCity.value = "";
              }
              this.isActive = false;
            }
            handlePropDetailsResponse(res){
              console.log(JSON.stringify(res.detail.response));
            }
        }
        window.customElements.define(PropertyDetails.is, PropertyDetails);
      </script>
</dom-module>
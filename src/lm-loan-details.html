<link rel="import" href="shared-styles.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">


<dom-module id="loan-details">
    <template>
        <style include="shared-styles">
            :host {
                display: block
            }
            .loan-details{
              width:90%;
              /* float:left; */
              min-height: 300px;              
              padding:10px 13%;
              box-sizing: border-box;              
              //margin:auto 5%;
              //margin-top: 80px;
              //border: 2px solid #F60;
            } 

          .loan-details paper-input,.loan-details paper-dropdown-menu{
               //width:100%;
               //float:left;
               margin:0 1% 0 ; 
          }
          .loan-details paper-input.smallBox{
            width: 10%;
          }
          .loan-details paper-input.mediumBox{
            width: 29%;
          }
          .loan-details paper-input.largeBox{
            width: 60%;
          }
          .loan-details paper-button {
            float: right;
          }
          paper-spinner-lite {
            --paper-spinner-color: #FF6600;
            position: absolute;
            top: 200px;
            left: 500px;
          }
          #cover {
            position: fixed;
            top:0;
            left:0;
            background:#000;
            opacity: 0.6;
            width: 100%;
            height: 100%;
            display: none;
            z-index:5;
          }

        </style>
        <div class="loan-details">
          <div id="cover"></div>
          <section>
            <paper-spinner-lite active$="{{isActive}}" class="orange active"></paper-spinner-lite>
            <paper-dropdown-menu label="Current Lender"  id="id" name="bank">
              <paper-listbox slot="dropdown-content" on-iron-select="itemSelected">
                <paper-item value="aegon">AEGON</paper-item>
                <paper-item value="abnamrobank">ABN AMRO Bank</paper-item>
                <paper-item value="deltalloyd">Delta Lloyd</paper-item>
                <paper-item value="asr">ASR</paper-item>
              </paper-listbox>
            </paper-dropdown-menu>
            <paper-input name="mortgageContractNumber"  class="" label="Mortgage Contract Number" id="mortgageContractNumber" value="{{loandetails.mortgageContractNumber::input}}" on-blur="getOutstandingAmount"></paper-input>
            <paper-input name="OutstandingBal" readonly class="" label="Current Outstanding Balance" id="outstandingBal" value="{{loandetails.outstandingBal::input}}">
              <iron-icon icon="euro-symbol" slot="prefix"></iron-icon>
            </paper-input>
            
            <br/>
            <paper-button id="btnSubmit" raised class="custom orange" on-click="submitDetails">Submit</paper-button>
            <paper-dialog id="dialogBox" no-cancel-on-outside-click>
              <div on-click="closeDialog">
                <paper-icon-button icon="icons:cancel" title="Close" dialog-dismiss></paper-icon-button>
              </div>
                <label>Please provide Current lender and Mortgage contract number</label>      
                <paper-button class="custom dialog-orange" dialog-dismiss on-click="closeDialog">Ok</paper-button>         
            </paper-dialog>

            <paper-dialog id="dialogBoxOutStandingError" no-cancel-on-outside-click>
              <div on-click="closeDialog">
                <paper-icon-button icon="icons:cancel" title="Close" dialog-dismiss></paper-icon-button>
              </div>
                <label>Invalid Current lender or Mortgage contract number</label>  
                <paper-button class="custom dialog-orange" dialog-dismiss on-click="closeDialog">Ok</paper-button>             
            </paper-dialog>

            <iron-ajax id="outstandingDetailsReq" url="{{outstandingBalReqAPI}}" method="get" body='{{loandetails}}' handle-as="json" content-type="application/json" on-response="handleOutstandingDetailsResponse" on-error="handleOutstandingErrorResponse">
            </iron-ajax>
          </section>
        </div>
      </template>
      <script>
        class LoanDetails extends Polymer.Element {

            static get is() { return 'loan-details'; }
            static get properties() {
                return {              
                  loandetails:{
                        type:Object,
                        value:{},
                        notify:true,
                        reflectToAttribute:true
                    },
                    isActive:{
                      type : Boolean,
                      value : false
                    },
                }
            }
            constructor() {
                super();
            }
           itemSelected(e) {
              var selectedItem = e.target.selectedItem;
              //console.log(selectedItem.getAttribute("value"));
              this.loandetails.bankName = "";
              if (selectedItem) {
                this.loandetails.bankName = selectedItem.getAttribute("value");
              }
            }
            getOutstandingAmount(){
             //console.log("req data "+JSON.stringify(this.loandetails));
             this.isActive = true;
             this.outstandingBalReqAPI = "http://10.138.13.58:8080/lightningmortgage/existingLoan/outStandingAmount?bankName="+this.loandetails.bankName+"&mortgageContractNumber="+this.loandetails.mortgageContractNumber;
             //this.$.btnSubmit.disabled= true;
             this.$.outstandingDetailsReq.generateRequest();
            }
            handleOutstandingDetailsResponse(res){
              this.isActive = false;
              let response = res.detail.response;
              //this.$.btnSubmit.disabled= false;
              //console.log("jjjjjj"+JSON.stringify(res.detail.response));
              this.$.outstandingBal.value = res.detail.response.outstandingAmount;
              this.loandetails.outstandingBal = res.detail.response.outstandingAmount;
            }
            handleOutstandingErrorResponse(res){
              this.$.dialogBoxOutStandingError.open();
              this.$.cover.style.display = "block";

              this.isActive = false;
            }
            submitDetails(){
              //console.log("bababa "+this.loandetails.outstandingBal);
              if(this.loandetails.bankName==undefined || this.loandetails.mortgageContractNumber==undefined){
                this.$.dialogBox.open();
                this.$.cover.style.display = "block";
                this.isActive = false;
                return;
              } else {
                if(this.loandetails.outstandingBal > 0){
                  localStorage.postalCode = "";
                  localStorage.outstandingBalance = this.loandetails.outstandingBal;
                  window.history.pushState({},"", '/products/');
                  window.dispatchEvent(new CustomEvent('location-changed'));
                } else {
                  this.loandetails.outstandingBal = 0;
                  this.$.dialogBoxOutStandingError.close();
                  this.$.dialogBoxOutStandingError.open();
                  this.$.cover.style.display = "block";
                  this.isActive = false;
                }
              }
            }
            closeDialog(){
              this.$.cover.style.display="none";
            }
        }
        window.customElements.define(LoanDetails.is, LoanDetails);
      </script>
</dom-module>
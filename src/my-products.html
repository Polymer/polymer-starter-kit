<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="./lm-slider.html">
<link rel="import" href="./term-conditions.html">
<link rel="import" href="shared-styles.html">

<dom-module id="product-preference">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;
      }
      header
      {
        text-align: center;
      }
      .paper-button
      {
        background-color: #f60;
        color: white
      }
      .details-container
      {
        background-color: white;
        border-radius: 5px;
        overflow: auto;
        padding:1em 2em;
         display: block;
      }
      paper-card.white {
          --paper-card-header-color:black;
        }
        paper-card
        {
          text-align: center;
          width:400px;
          cursor: pointer;
          margin: 20px;
          padding-bottom : 25px;
          border-radius: 5px; 
          
          

        }
        .flex-container{
          
          flex-direction: row;
          flex-wrap: wrap;
        }
        .flex-item{
          flex:1;
        }
        .flex-container-bleed{
            @apply(--layout-horizontal);
            @apply(--layout-wrap);
            justify-content: center;
       }
       .flex-item-4{
           @apply(--layout-flex-4);
       }
       .bold-item{
            font-weight: bold;
       }
       paper-card.selected {
        --paper-card-header-text:{
          color : #f60;
        }
        --paper-card-content:{
          color : #f60;
        }
       }
       .submittedClass {
            padding: 10px;
            color: green;
            font-weight: normal;
            font-size: 15px;
            display: block;
            margin-top: 10px;
            text-align: center;
        } 
       
       label.center{
        text-align: center;
        margin-left: 23px;
        font-weight: bold;
       }
       .center{
         text-align:center;
      }

      
    </style>
  
    <div class="flex-container">
      <template is="dom-repeat" items="[[products.product]]">
        <paper-card  heading="[[item.productName]]" on-click="_getProductDetails"  class="white flex-item">
           <div class="card-content">[[item.productDesc]]</div>
        </paper-card>
      </template>
    </div>

    <div class="details-container"> 

    
        <label class='center'>[[productItem.productName]]</label>      

       <div class="card">


        <lm-slider title='Tenure' minval='{{termValues.minTerm}}' maxval='{{termValues.maxTerm}}' selected='{{offerterm}}' interval='{{termValues.termStep}}' suffix='Yrs'></lm-slider>      
        <lm-slider title='Amount' prefix='&euro;' minval='{{amountValues.minAmount}}' selected='{{offeramount}}' interval='{{amountValues.amountStep}}' maxval='{{amountValues.maxAmount}}'></lm-slider>      
        <lm-slider title='Down Payment' prefix='&euro;' minval='{{offerdownpayment}}' selected='{{offerdownpayment}}' maxval='{{offerdownpayment}}' isdisabled='true'></lm-slider>

        </div>
        <div class="card flex-container-bleed"> 
           <div class="flex-item-4 bold-item">
                <div>Equated Periodic Installment(EPI) :  {{epi}}</div>               
           </div>
            <div class="flex-item-4 bold-item">
                <div>Effective APR% : 2.0</div>                  
            </div>
        </div>

        <term-conditions terms="[[termsArray]]"></term-conditions>
        <div class="center">

          <paper-button class="paper-button" on-click="_submitInfo">Submit</paper-button>
             
           </div>
          <template is="dom-if" if="[[datasubmitted]]" restamp>
              <label class="center" >Data submitted successfully!</label>
          </template> 

    </div>
    
     <iron-ajax
          auto
          url="http://10.138.65.58:8080/lightningmortgage/identifyProduct/"
          params='{{params}}'
          handle-as="json"
          on-response="_handleResponseForProducts"
          debounce-duration="300">
     </iron-ajax>

     <iron-ajax id="ironAjaxSubmit"
     url="http://127.0.0.1:8081/products"
     handle-as="json"
     body='{{postBody}}'
     method="post"
     on-response="sendResponse"
     content-type="application/json">
</iron-ajax>


  </template>
  

  <script>
    class ProductPreference extends Polymer.Element 
    {
      constructor()
      {
        super();
        this.products=[];
        
      }     

      static get is() { return 'product-preference'; }

      static get properties()
      {
        return {
          productName:{
            type:String,
            value:"Product Name"
          },
          productItem:{
            type:Object,
            value:{},
            observer:"_productChanged"
          },
          termValues:{
            type:Object,
            value:{},
            observer:"_productChanged"
          },
          amountValues:{
            type:Object,
            value:{},
            observer:"_productChanged"
          },
          offeramount:{
            type:Number,
            observer:"_amountChanged"
          },
          offerterm:{
            type:Number,
            observer:"_termChanged"
          },
          offerdownpayment:{
            type:Number
          },
          epi:{
            type:String,
            value:"392"

          },
          apr:{
            type:String,
            value:"2.4"

          },

          postBody: {
              type: Object,
              value: {

              }
          },
          datasubmitted: {
              type: Boolean,
              value: false

          },
          termsArray : Array

          }


        }
      

      updateEPI_APR(data,term,offer)
      {
        for(let i=0;i<data.length;i++)
        {
          if(term==data[i].productTerm)
          {
            if(offer==data[i].offerValue)
            {
              this.epi=data[i].epi;
            }
          }
        }
      }
        // console.log("updating");
        // this.epi = this.offeramount+this.offerterm+this.offerdownpayment;
        // console.log("EPI is ", this.epi);
        // this.apr = this.offeramount-this.offerterm+this.offerdownpayment;
        // console.log("APR  is ",this.apr);

        


      _getProductDetails(event)
      {
        let selectedIndex = event.model.__data.index;
        // this.productItem = event.model.item;
        // this.offeramount=this.productItem.maxAmount;
        // this.offerterm=this.productItem.maxTenure;
        // this.offerdownpayment=this.productItem.maxDownpayment;
        var classList = this.shadowRoot.querySelectorAll('paper-card');
           classList.forEach((e)=>{
               e.classList.remove('selected');
           });
          classList[selectedIndex].classList.add('selected');
      }

     
      _amountChanged(newValue,oldValue)
      {
        console.log(newValue+"amount"+oldValue);
        if(oldValue!==undefined)
        {
          console.log("called amount changed");
        this.updateEPI_APR(this.productDetails,this.offerterm,this.offeramount);
        }
      }
      _termChanged(newValue,oldValue)
      {
        console.log(newValue+"amount"+oldValue);
        if(oldValue!==undefined)
        {
          this.amountValues= this.setAmountMinMaxStep(this.productDetails,this.offerterm);
          this.offeramount=this.amountValues.maxAmount;
       // this.updateEPI_APR();
       this.updateEPI_APR(this.productDetails,this.offerterm,this.offeramount);
      
        }
      }
      

      _productChanged(newValue,oldValue)
      {
        console.log("value changed "+newValue);
      }

      _paramChanged(newValue,oldValue)
      {
        console.log(oldValue+"new"+newValue);
      }
      

      // _submitInfo()
      // {
      //  let tempParam={};
      //   tempParam.name = "sss";
      //   this.params=tempParam;
      //   console.log(this.tempParam);
      // }
       //<!--code for submit data-->
       _submitInfo() 
       {
          console.log("clicked submit");
          this.datasubmitted = true;
          this.postBody.term=this.offerterm;
          this.postBody.offeramount=this.offeramount;
          this.postBody.downPayment=20000;//hardcoded;
          this.postBody.epi=this.epi;
          this.postBody.apr=this.apr;
          this.postBody.productId=this.productId;
          //if customer id set it
          this.$.ironAjaxSubmit.generateRequest();
      }
      //<!--code for submit data-->
      sendResponse(data)
       {
          console.log('function called successfully')
          if (result && result.status === "200")
           {
              this.datasubmitted = true
              console.log('Data sent successfully')
          }
      } 
      setTermMinMaxStep(data)
      {
        let tempMin=data[0].productTerm;
        let tempMax=0;
        let tempStep=0;
        for(let i=0;i<data.length;i++)
        {
          if(data[i].productTerm  < tempMin  ){
            tempStep=tempMin-data[i].productTerm;
            tempMin = data[i].productTerm;
          }
          if(data[i].productTerm  > tempMax ){
            tempStep=data[i].productTerm-tempMax;
            tempMax = data[i].productTerm;
          }
        }
        console.log("min"+tempMin + " " + tempMax + " " + this.termValues.termStep);
        var tempObj = {};
        tempObj.minTerm = tempMin;
        tempObj.maxTerm = tempMax;
        tempObj.termStep = tempStep;

        return tempObj;
        //  this.productValues.minTerm = tempMin;
        //  this.productValues.maxTerm = tempMax;
        
      }
      setAmountMinMaxStep(data,term)
      {
        let tempMin=0;
        let tempMax=0;
        let tempStep=0;
        for(let i=0;i<data.length;i++)
        {
          console.log("term is "+data[i].productTerm);
          if(term==data[i].productTerm)
          {
            if(tempMin==0)
            {
            tempMin=data[i].offerValue;
            }
            if(data[i].offerValue  < tempMin  )
            {
              tempStep=tempMin-data[i].offerValue;
            tempMin = data[i].offerValue;
            }
           if(data[i].offerValue  > tempMax )
            {
              tempStep=data[i].offerValue-tempMax;
            tempMax = data[i].offerValue;
            }
          }
        }
        var tempObj = {};
        tempObj.minAmount = tempMin;
        tempObj.maxAmount = tempMax;
        tempObj.amountStep = tempStep;

        return tempObj;
        //this.productValues.minAmount = tempMin;
        //this.productValues.maxAmount = tempMax;

      }
      //getAPI
      _handleResponseForProducts(data)
      {
        console.log("in response for products"+data.detail.response);
        this.products = data.detail.response;
        console.log("product values "+JSON.stringify(this.products));
        this.productDetails = this.products.offer;

        console.log("prod de"+this.productDetails);
        if(this.products)
        {

          this.productId = this.products.product.productId//this.products[0].productId;
          console.log("hi"+JSON.stringify(this.productDetails));
          this.termValues = this.setTermMinMaxStep(this.productDetails);

        this.offerterm=this.termValues.maxTerm;
        this.amountValues= this.setAmountMinMaxStep(this.productDetails,this.offerterm);
        this.offeramount=this.amountValues.maxAmount;
        this.termsArray = this.products.product[0].terms;//this.products[0].terms;
        this.offerdownpayment=10000; //change according to json from service
        
        
        }


      }
      
      }

    

    

    window.customElements.define(ProductPreference.is, ProductPreference);
  </script>
</dom-module>
